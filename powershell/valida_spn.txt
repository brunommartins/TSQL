# FunÃ§Ã£o para buscar conta de serviÃ§o do SQL Server
function Get-SQLServiceAccount {
    param ($instancia)

    $serviceName = if ($instancia -eq "MSSQLSERVER") { "MSSQLSERVER" } else { "MSSQL$" + $instancia }
    $wmi = Get-WmiObject -Class Win32_Service -Filter "Name = '$serviceName'" -ErrorAction SilentlyContinue

    if ($wmi) {
        return $wmi.StartName
    } else {
        Write-Warning "âš ï¸ NÃ£o foi possÃ­vel encontrar o serviÃ§o $serviceName"
        return $null
    }
}

# Pegando nome do servidor
$SQLServerName = $env:COMPUTERNAME
$FQDN = [System.Net.Dns]::GetHostByName($SQLServerName).HostName
$instanciasSQL = @()

# Lendo instÃ¢ncias instaladas
$regPath = "HKLM:\SOFTWARE\Microsoft\Microsoft SQL Server"
(Get-ItemProperty -Path $regPath).InstalledInstances | ForEach-Object {
    $instanciasSQL += $_
}

Write-Host "`nğŸ” Verificando SPNs para as instÃ¢ncias SQL..."

foreach ($instancia in $instanciasSQL) {
    $isDefaultInstance = ($instancia -eq "MSSQLSERVER")
    $nomeInstancia = if ($isDefaultInstance) { $SQLServerName } else { "$SQLServerName\$instancia" }
    $port = 1433  # Altere se necessÃ¡rio

    $serviceAccount = Get-SQLServiceAccount -instancia $instancia
    if (-not $serviceAccount) { continue }

    # Contas locais nÃ£o requerem SPN manual
    if ($serviceAccount -like "*LocalSystem" -or $serviceAccount -like "*LocalService" -or $serviceAccount -like "*NetworkService") {
        Write-Host "âš ï¸ Conta $serviceAccount Ã© gerenciada pelo sistema. SPN nÃ£o precisa ser registrado manualmente.`n"
        continue
    }

    # CorreÃ§Ã£o com $() para evitar erros de formataÃ§Ã£o
    $spn1 = if ($isDefaultInstance) { "MSSQLSvc/$($SQLServerName):$port" } else { "MSSQLSvc/$($SQLServerName)\$instancia" }
    $spn2 = if ($isDefaultInstance) { "MSSQLSvc/$($FQDN):$port" } else { "MSSQLSvc/$($FQDN)\$instancia" }

    $spnsEsperados = @($spn1, $spn2)
    $spnsRegistrados = setspn -L $serviceAccount 2>$null

    foreach ($spn in $spnsEsperados) {
        if ($spnsRegistrados -match [regex]::Escape($spn)) {
            Write-Host "âœ… SPN existe: $spn"
        } else {
            Write-Warning "âŒ SPN ausente: $spn"
            Write-Host "ğŸ‘‰ Comando para registrar:"
            Write-Host "setspn -A $spn $serviceAccount"
        }
    }

    Write-Host ""
}
