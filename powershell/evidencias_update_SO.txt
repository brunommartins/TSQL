# ================================
# CONFIGURAÇÕES
# ================================
$Server = $env:COMPUTERNAME
$LogFile = "C:\Temp\Evidencias_$Server.log"
$DebugMode = $true  # coloque $false para desligar o debug

Function Write-Log {
    param([string]$msg)
    if ($DebugMode) {
        $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
        Add-Content -Path $LogFile -Value "[$timestamp] $msg"
    }
}

Write-Host "`n=== COLETAR ÚLTIMAS ATUALIZAÇÕES DO WINDOWS ===" -ForegroundColor Cyan
Write-Log "Iniciando coleta de atualizações do Windows."

# ================================
# COLETAR ÚLTIMAS ATUALIZAÇÕES DO WINDOWS
# ================================
try {
    $updates = Get-HotFix |
        Sort-Object InstalledOn -Descending |
        Select-Object -First 4 @{Name="Servidor"; Expression={$Server}}, Source, Description, HotFixID, InstalledOn

    Write-Log "Atualizações coletadas com sucesso: $($updates.Count) registros."

    $updates | Format-Table -AutoSize
}
catch {
    Write-Host "Erro ao coletar atualizações: $_" -ForegroundColor Red
    Write-Log "Erro ao coletar atualizações: $_"
}

# ================================
# COLETAR VERSÃO DO SQL SERVER (TODAS AS INSTÂNCIAS LOCAIS)
# ================================
Write-Host "`n=== SQL SERVER VERSION ===" -ForegroundColor Cyan
Write-Log "Iniciando coleta da versão do SQL Server (todas as instâncias locais)."

# Lê instâncias do registro
$instanceKey = 'HKLM:\SOFTWARE\Microsoft\Microsoft SQL Server\Instance Names\SQL'

if (Test-Path $instanceKey) {
    $instances = (Get-Item $instanceKey).GetValueNames()

    foreach ($inst in $instances) {
        if ($inst -eq 'MSSQLSERVER') {
            # Instância default
            $serverInstance = $env:COMPUTERNAME
        }
        else {
            # Instância nomeada
            $serverInstance = "$env:COMPUTERNAME\$inst"
        }

        Write-Host "Coletando versão da instância: $serverInstance" -ForegroundColor Yellow
        Write-Log "Coletando versão da instância: $serverInstance"

        try {
            $sqlInfo = Invoke-Sqlcmd -Query "
                SELECT
                    @@SERVERNAME AS Servidor,
                    @@VERSION   AS Versao
            " -ServerInstance $serverInstance -ErrorAction Stop

            Write-Log "Versão SQL coletada com sucesso para $serverInstance."
            $sqlInfo | Format-Table -AutoSize
        }
        catch {
            Write-Host "Erro ao coletar versão do SQL Server em $serverInstance : $_" -ForegroundColor Red
            Write-Log "Erro ao coletar versão do SQL Server em $serverInstance : $_"
        }
    }
}
else {
    Write-Host "Nenhuma instância SQL encontrada no registro." -ForegroundColor Red
    Write-Log "Chave de instância SQL não encontrada: $instanceKey"
}

Write-Log "Processo de coleta de versão do SQL Server concluído."
Write-Host "`nColeta finalizada." -ForegroundColor Green
